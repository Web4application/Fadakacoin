#!/usr/bin/env bash
set -euo pipefail

# Miner version
MINER_VER="${CUSTOM_VER:-$(miner_ver)}"
echo "Using miner version: $MINER_VER"

MINER_CONFIG="$MINER_DIR/$MINER_NAME/lolminer.conf"
GLOBAL_CONFIG="$MINER_DIR/$MINER_NAME/global_config.conf"

mkfile_from_symlink "$MINER_CONFIG"

conf=""

# Algorithm
case "$CUSTOM_ALGO" in
  ethash)      conf+="--algo ETHASH\n" ;;
  etchash)     conf+="--algo ETCHASH\n" ;;
  autolykos2|autolykos)
               conf+="--algo AUTOLYKOS2\n" ;;
  beamhashv3)  conf+="--algo BEAM-III\n" ;;
  ubqhash)     conf+="--algo UBQHASH\n" ;;
  *)           conf+="--algo TON\n" ;;
esac

# Pools
read -ra LOLMINER_SERVER <<< "$CUSTOM_URL"
host_cnt="${#LOLMINER_SERVER[@]}"

for url in "${LOLMINER_SERVER[@]}"; do
  conf+="--pool $url\n"
  conf+="--user $CUSTOM_TEMPLATE\n"
  [[ -n "${CUSTOM_PASS:-}" ]] && conf+="--pass $CUSTOM_PASS\n"
done

# TLS
[[ "${CUSTOM_TLS:-0}" -eq 1 ]] && conf+="--tls 1\n"

# User overrides
while read -r line; do
  [[ -z "$line" ]] && continue
  tls_cnt=$(grep -o -- '--tls' <<< "$line" | wc -l)
  if [[ "$tls_cnt" -eq 1 ]]; then
    tls_val=$(awk '{print $2}' <<< "$line")
    for ((i=0; i<host_cnt; i++)); do
      conf+="--tls $tls_val\n"
    done
  else
    conf+="$line\n"
  fi
done <<< "${CUSTOM_USER_CONFIG:-}"

conf+="--apiport $CUSTOM_API_PORT\n"

[[ -f "$GLOBAL_CONFIG" ]] && conf+="$(cat "$GLOBAL_CONFIG")\n"

echo -e "$conf" > "$MINER_CONFIG"
